{"version":3,"file":"Sender.js","sourceRoot":"","sources":["../../Library/Sender.ts"],"names":[],"mappings":"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","sourcesContent":["import fs = require(\"fs\");\r\nimport http = require(\"http\");\r\nimport os = require(\"os\");\r\nimport path = require(\"path\");\r\nimport zlib = require(\"zlib\");\r\nimport child_process = require(\"child_process\");\r\n\r\nimport Logging = require(\"./Logging\");\r\nimport Config = require(\"./Config\")\r\nimport Contracts = require(\"../Declarations/Contracts\");\r\nimport Constants = require(\"../Declarations/Constants\");\r\nimport AutoCollectHttpDependencies = require(\"../AutoCollection/HttpDependencies\");\r\nimport Statsbeat = require(\"../AutoCollection/Statsbeat\");\r\nimport Util = require(\"./Util\");\r\nimport { URL } from \"url\";\r\n\r\n\r\nclass Sender {\r\n    private static TAG = \"Sender\";\r\n    private static ICACLS_PATH = `${process.env.systemdrive}/windows/system32/icacls.exe`;\r\n    private static POWERSHELL_PATH = `${process.env.systemdrive}/windows/system32/windowspowershell/v1.0/powershell.exe`;\r\n    private static ACLED_DIRECTORIES: { [id: string]: boolean } = {};\r\n    private static ACL_IDENTITY: string = null;\r\n\r\n    // the amount of time the SDK will wait between resending cached data, this buffer is to avoid any throttling from the service side\r\n    public static WAIT_BETWEEN_RESEND = 60 * 1000; // 1 minute\r\n    public static MAX_BYTES_ON_DISK = 50 * 1024 * 1024; // 50 mb\r\n    public static MAX_CONNECTION_FAILURES_BEFORE_WARN = 5;\r\n    public static CLEANUP_TIMEOUT = 60 * 60 * 1000; // 1 hour\r\n    public static FILE_RETEMPTION_PERIOD = 7 * 24 * 60 * 60 * 1000; // 7 days\r\n    public static TEMPDIR_PREFIX: string = \"appInsights-node\";\r\n    public static OS_PROVIDES_FILE_PROTECTION = false;\r\n    public static USE_ICACLS = os.type() === \"Windows_NT\";\r\n\r\n    private _config: Config;\r\n    private _statsbeat: Statsbeat;\r\n    private _onSuccess: (response: string) => void;\r\n    private _onError: (error: Error) => void;\r\n    private _enableDiskRetryMode: boolean;\r\n    private _numConsecutiveFailures: number;\r\n    private _numConsecutiveRedirects: number;\r\n    private _resendTimer: NodeJS.Timer | null;\r\n    private _fileCleanupTimer: NodeJS.Timer;\r\n    private _redirectedHost: string = null;\r\n    private _tempDir: string;\r\n    protected _resendInterval: number;\r\n    protected _maxBytesOnDisk: number;\r\n\r\n    constructor(config: Config, onSuccess?: (response: string) => void, onError?: (error: Error) => void, statsbeat?: Statsbeat) {\r\n        this._config = config;\r\n        this._onSuccess = onSuccess;\r\n        this._onError = onError;\r\n        this._statsbeat = statsbeat;\r\n        this._enableDiskRetryMode = false;\r\n        this._resendInterval = Sender.WAIT_BETWEEN_RESEND;\r\n        this._maxBytesOnDisk = Sender.MAX_BYTES_ON_DISK;\r\n        this._numConsecutiveFailures = 0;\r\n        this._numConsecutiveRedirects = 0;\r\n        this._resendTimer = null;\r\n        this._fileCleanupTimer = null;\r\n        // tmpdir is /tmp for *nix and USERDIR/AppData/Local/Temp for Windows\r\n        this._tempDir = path.join(os.tmpdir(), Sender.TEMPDIR_PREFIX + this._config.instrumentationKey);\r\n\r\n        if (!Sender.OS_PROVIDES_FILE_PROTECTION) {\r\n            // Node's chmod levels do not appropriately restrict file access on Windows\r\n            // Use the built-in command line tool ICACLS on Windows to properly restrict\r\n            // access to the temporary directory used for disk retry mode.\r\n            if (Sender.USE_ICACLS) {\r\n                // This should be async - but it's currently safer to have this synchronous\r\n                // This guarantees we can immediately fail setDiskRetryMode if we need to\r\n                try {\r\n                    Sender.OS_PROVIDES_FILE_PROTECTION = fs.existsSync(Sender.ICACLS_PATH);\r\n                } catch (e) { }\r\n                if (!Sender.OS_PROVIDES_FILE_PROTECTION) {\r\n                    Logging.warn(Sender.TAG, \"Could not find ICACLS in expected location! This is necessary to use disk retry mode on Windows.\")\r\n                }\r\n            } else {\r\n                // chmod works everywhere else\r\n                Sender.OS_PROVIDES_FILE_PROTECTION = true;\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n    * Enable or disable offline mode\r\n    */\r\n    public setDiskRetryMode(value: boolean, resendInterval?: number, maxBytesOnDisk?: number) {\r\n        this._enableDiskRetryMode = Sender.OS_PROVIDES_FILE_PROTECTION && value;\r\n        if (typeof resendInterval === 'number' && resendInterval >= 0) {\r\n            this._resendInterval = Math.floor(resendInterval);\r\n        }\r\n        if (typeof maxBytesOnDisk === 'number' && maxBytesOnDisk >= 0) {\r\n            this._maxBytesOnDisk = Math.floor(maxBytesOnDisk);\r\n        }\r\n\r\n        if (value && !Sender.OS_PROVIDES_FILE_PROTECTION) {\r\n            this._enableDiskRetryMode = false;\r\n            Logging.warn(Sender.TAG, \"Ignoring request to enable disk retry mode. Sufficient file protection capabilities were not detected.\")\r\n        }\r\n        if (this._enableDiskRetryMode) {\r\n            if (this._statsbeat) {\r\n                this._statsbeat.addFeature(Constants.StatsbeatFeature.DISK_RETRY);\r\n            }\r\n            // Starts file cleanup task\r\n            if (!this._fileCleanupTimer) {\r\n                this._fileCleanupTimer = setTimeout(() => { this._fileCleanupTask(); }, Sender.CLEANUP_TIMEOUT);\r\n                this._fileCleanupTimer.unref();\r\n            }\r\n        }\r\n        else {\r\n            if (this._statsbeat) {\r\n                this._statsbeat.removeFeature(Constants.StatsbeatFeature.DISK_RETRY);\r\n            }\r\n            if (this._fileCleanupTimer) {\r\n                clearTimeout(this._fileCleanupTimer);\r\n            }\r\n        }\r\n    }\r\n\r\n    public async send(envelopes: Contracts.EnvelopeTelemetry[], callback?: (v: string) => void) {\r\n        if (envelopes) {\r\n            var endpointUrl = this._redirectedHost || this._config.endpointUrl;\r\n\r\n            var endpointHost = new URL(endpointUrl).hostname;\r\n\r\n            // todo: investigate specifying an agent here: https://nodejs.org/api/http.html#http_class_http_agent\r\n            var options = {\r\n                method: \"POST\",\r\n                withCredentials: false,\r\n                headers: <{ [key: string]: string }>{\r\n                    \"Content-Type\": \"application/x-json-stream\"\r\n                }\r\n            };\r\n\r\n            let batch: string = \"\";\r\n            envelopes.forEach(envelope => {\r\n                var payload: string = this._stringify(envelope);\r\n                if (typeof payload !== \"string\") {\r\n                    return;\r\n                }\r\n                batch += payload + \"\\n\";\r\n            });\r\n            // Remove last \\n\r\n            if (batch.length > 0) {\r\n                batch = batch.substring(0, batch.length - 1);\r\n            }\r\n\r\n            let payload: Buffer = Buffer.from ? Buffer.from(batch) : new Buffer(batch);\r\n\r\n            zlib.gzip(payload, (err, buffer) => {\r\n                var dataToSend = buffer;\r\n                if (err) {\r\n                    Logging.warn(err);\r\n                    dataToSend = payload; // something went wrong so send without gzip\r\n                    options.headers[\"Content-Length\"] = payload.length.toString();\r\n                } else {\r\n                    options.headers[\"Content-Encoding\"] = \"gzip\";\r\n                    options.headers[\"Content-Length\"] = buffer.length.toString();\r\n                }\r\n\r\n                Logging.info(Sender.TAG, options);\r\n\r\n                // Ensure this request is not captured by auto-collection.\r\n                (<any>options)[AutoCollectHttpDependencies.disableCollectionRequestOption] = true;\r\n\r\n                let startTime = +new Date();\r\n\r\n                var requestCallback = (res: http.ClientResponse) => {\r\n                    res.setEncoding(\"utf-8\");\r\n\r\n                    //returns empty if the data is accepted\r\n                    var responseString = \"\";\r\n                    res.on(\"data\", (data: string) => {\r\n                        responseString += data;\r\n                    });\r\n\r\n                    res.on(\"end\", () => {\r\n                        let endTime = +new Date();\r\n                        let duration = endTime - startTime;\r\n                        this._numConsecutiveFailures = 0;\r\n                        if (this._enableDiskRetryMode) {\r\n                            // try to send any cached events if the user is back online\r\n                            if (res.statusCode === 200) {\r\n                                if (!this._resendTimer) {\r\n                                    this._resendTimer = setTimeout(() => {\r\n                                        this._resendTimer = null;\r\n                                        this._sendFirstFileOnDisk()\r\n                                    }, this._resendInterval);\r\n                                    this._resendTimer.unref();\r\n                                }\r\n                            } else if (this._isRetriable(res.statusCode)) {\r\n                                try {\r\n                                    if (this._statsbeat) {\r\n                                        this._statsbeat.countRetry(Constants.StatsbeatNetworkCategory.Breeze, endpointHost);\r\n                                        if (res.statusCode === 429) {\r\n                                            this._statsbeat.countThrottle(Constants.StatsbeatNetworkCategory.Breeze, endpointHost);\r\n                                        }\r\n                                    }\r\n                                    const breezeResponse = JSON.parse(responseString) as Contracts.BreezeResponse;\r\n                                    let filteredEnvelopes: Contracts.EnvelopeTelemetry[] = [];\r\n                                    breezeResponse.errors.forEach(error => {\r\n                                        if (this._isRetriable(error.statusCode)) {\r\n                                            filteredEnvelopes.push(envelopes[error.index]);\r\n                                        }\r\n                                    });\r\n                                    if (filteredEnvelopes.length > 0) {\r\n                                        this._storeToDisk(filteredEnvelopes);\r\n                                    }\r\n                                }\r\n                                catch (ex) {\r\n                                    this._storeToDisk(envelopes); // Retriable status code with not valid Breeze response\r\n                                }\r\n                            }\r\n                        }\r\n                        // Redirect handling\r\n                        if (res.statusCode === 307 || // Temporary Redirect\r\n                            res.statusCode === 308) { // Permanent Redirect\r\n                            this._numConsecutiveRedirects++;\r\n                            // To prevent circular redirects\r\n                            if (this._numConsecutiveRedirects < 10) {\r\n                                // Try to get redirect header\r\n                                const locationHeader = res.headers[\"location\"] ? res.headers[\"location\"].toString() : null;\r\n                                if (locationHeader) {\r\n                                    this._redirectedHost = locationHeader;\r\n                                    // Send to redirect endpoint as HTTPs library doesn't handle redirect automatically\r\n                                    this.send(envelopes, callback);\r\n                                }\r\n                            }\r\n                            else {\r\n                                if (this._statsbeat) {\r\n                                    this._statsbeat.countException(Constants.StatsbeatNetworkCategory.Breeze, endpointHost);\r\n                                }\r\n                                if (typeof callback === \"function\") {\r\n                                    callback(\"Error sending telemetry because of circular redirects.\");\r\n                                }\r\n                            }\r\n\r\n                        }\r\n                        else {\r\n                            if (this._statsbeat) {\r\n                                this._statsbeat.countRequest(Constants.StatsbeatNetworkCategory.Breeze, endpointHost,duration, res.statusCode === 200);\r\n                            }\r\n                            this._numConsecutiveRedirects = 0;\r\n                            if (typeof callback === \"function\") {\r\n                                callback(responseString);\r\n                            }\r\n                            Logging.info(Sender.TAG, responseString);\r\n                            if (typeof this._onSuccess === \"function\") {\r\n                                this._onSuccess(responseString);\r\n                            }\r\n                        }\r\n                    });\r\n                };\r\n\r\n                var req = Util.makeRequest(this._config, endpointUrl, options, requestCallback);\r\n\r\n                req.on(\"error\", (error: Error) => {\r\n                    // todo: handle error codes better (group to recoverable/non-recoverable and persist)\r\n                    this._numConsecutiveFailures++;\r\n                    if (this._statsbeat) {\r\n                        this._statsbeat.countException(Constants.StatsbeatNetworkCategory.Breeze, endpointHost);\r\n                    }\r\n\r\n                    // Only use warn level if retries are disabled or we've had some number of consecutive failures sending data\r\n                    // This is because warn level is printed in the console by default, and we don't want to be noisy for transient and self-recovering errors\r\n                    // Continue informing on each failure if verbose logging is being used\r\n                    if (!this._enableDiskRetryMode || this._numConsecutiveFailures > 0 && this._numConsecutiveFailures % Sender.MAX_CONNECTION_FAILURES_BEFORE_WARN === 0) {\r\n                        let notice = \"Ingestion endpoint could not be reached. This batch of telemetry items has been lost. Use Disk Retry Caching to enable resending of failed telemetry. Error:\";\r\n                        if (this._enableDiskRetryMode) {\r\n                            notice = `Ingestion endpoint could not be reached ${this._numConsecutiveFailures} consecutive times. There may be resulting telemetry loss. Most recent error:`;\r\n                        }\r\n                        Logging.warn(Sender.TAG, notice, Util.dumpObj(error));\r\n                    } else {\r\n                        let notice = \"Transient failure to reach ingestion endpoint. This batch of telemetry items will be retried. Error:\";\r\n                        Logging.info(Sender.TAG, notice, Util.dumpObj(error))\r\n                    }\r\n                    this._onErrorHelper(error);\r\n\r\n                    if (typeof callback === \"function\") {\r\n                        if (error) {\r\n                            callback(Util.dumpObj(error));\r\n                        }\r\n                        else {\r\n                            callback(\"Error sending telemetry\");\r\n                        }\r\n                    }\r\n\r\n                    if (this._enableDiskRetryMode) {\r\n                        this._storeToDisk(envelopes);\r\n                    }\r\n                });\r\n\r\n                req.write(dataToSend);\r\n                req.end();\r\n            });\r\n        }\r\n    }\r\n\r\n    public saveOnCrash(envelopes: Contracts.EnvelopeTelemetry[]) {\r\n        if (this._enableDiskRetryMode) {\r\n            this._storeToDiskSync(this._stringify(envelopes));\r\n        }\r\n    }\r\n\r\n    private _isRetriable(statusCode: number) {\r\n        return (\r\n            statusCode === 206 || // Retriable\r\n            statusCode === 408 || // Timeout\r\n            statusCode === 429 || // Throttle\r\n            statusCode === 439 || // Quota\r\n            statusCode === 500 || // Server Error\r\n            statusCode === 503 // Server Unavilable\r\n        );\r\n    }\r\n\r\n    private _runICACLS(args: string[], callback: (err: Error) => void) {\r\n        var aclProc = child_process.spawn(Sender.ICACLS_PATH, args, <any>{ windowsHide: true });\r\n        aclProc.on(\"error\", (e: Error) => callback(e));\r\n        aclProc.on(\"close\", (code: number, signal: string) => {\r\n            return callback(code === 0 ? null : new Error(`Setting ACL restrictions did not succeed (ICACLS returned code ${code})`));\r\n        });\r\n    }\r\n\r\n    private _runICACLSSync(args: string[]) {\r\n        // Some very old versions of Node (< 0.11) don't have this\r\n        if (child_process.spawnSync) {\r\n            var aclProc = child_process.spawnSync(Sender.ICACLS_PATH, args, <any>{ windowsHide: true });\r\n            if (aclProc.error) {\r\n                throw aclProc.error;\r\n            } else if (aclProc.status !== 0) {\r\n                throw new Error(`Setting ACL restrictions did not succeed (ICACLS returned code ${aclProc.status})`);\r\n            }\r\n        } else {\r\n            throw new Error(\"Could not synchronously call ICACLS under current version of Node.js\");\r\n        }\r\n    }\r\n\r\n    private _getACLIdentity(callback: (error: Error, identity: string) => void) {\r\n        if (Sender.ACL_IDENTITY) {\r\n            return callback(null, Sender.ACL_IDENTITY);\r\n        }\r\n        var psProc = child_process.spawn(Sender.POWERSHELL_PATH,\r\n            [\"-Command\", \"[System.Security.Principal.WindowsIdentity]::GetCurrent().Name\"], <any>{\r\n                windowsHide: true,\r\n                stdio: ['ignore', 'pipe', 'pipe'] // Needed to prevent hanging on Win 7\r\n            });\r\n        let data = \"\";\r\n        psProc.stdout.on(\"data\", (d: string) => data += d);\r\n        psProc.on(\"error\", (e: Error) => callback(e, null));\r\n        psProc.on(\"close\", (code: number, signal: string) => {\r\n            Sender.ACL_IDENTITY = data && data.trim();\r\n            return callback(\r\n                code === 0 ? null : new Error(`Getting ACL identity did not succeed (PS returned code ${code})`),\r\n                Sender.ACL_IDENTITY);\r\n        });\r\n    }\r\n\r\n    private _getACLIdentitySync() {\r\n        if (Sender.ACL_IDENTITY) {\r\n            return Sender.ACL_IDENTITY;\r\n        }\r\n        // Some very old versions of Node (< 0.11) don't have this\r\n        if (child_process.spawnSync) {\r\n            var psProc = child_process.spawnSync(Sender.POWERSHELL_PATH,\r\n                [\"-Command\", \"[System.Security.Principal.WindowsIdentity]::GetCurrent().Name\"], <any>{\r\n                    windowsHide: true,\r\n                    stdio: ['ignore', 'pipe', 'pipe'] // Needed to prevent hanging on Win 7\r\n                });\r\n            if (psProc.error) {\r\n                throw psProc.error;\r\n            } else if (psProc.status !== 0) {\r\n                throw new Error(`Getting ACL identity did not succeed (PS returned code ${psProc.status})`);\r\n            }\r\n            Sender.ACL_IDENTITY = psProc.stdout && psProc.stdout.toString().trim();\r\n            return Sender.ACL_IDENTITY;\r\n        } else {\r\n            throw new Error(\"Could not synchronously get ACL identity under current version of Node.js\");\r\n        }\r\n    }\r\n\r\n    private _getACLArguments(directory: string, identity: string) {\r\n        return [directory,\r\n            \"/grant\", \"*S-1-5-32-544:(OI)(CI)F\", // Full permission for Administrators\r\n            \"/grant\", `${identity}:(OI)(CI)F`, // Full permission for current user\r\n            \"/inheritance:r\"]; // Remove all inherited permissions\r\n    }\r\n\r\n    private _applyACLRules(directory: string, callback: (err: Error) => void) {\r\n        if (!Sender.USE_ICACLS) {\r\n            return callback(null);\r\n        }\r\n\r\n        // For performance, only run ACL rules if we haven't already during this session\r\n        if (Sender.ACLED_DIRECTORIES[directory] === undefined) {\r\n            // Avoid multiple calls race condition by setting ACLED_DIRECTORIES to false for this directory immediately\r\n            // If batches are being failed faster than the processes spawned below return, some data won't be stored to disk\r\n            // This is better than the alternative of potentially infinitely spawned processes\r\n            Sender.ACLED_DIRECTORIES[directory] = false;\r\n\r\n            // Restrict this directory to only current user and administrator access\r\n            this._getACLIdentity((err, identity) => {\r\n                if (err) {\r\n                    Sender.ACLED_DIRECTORIES[directory] = false; // false is used to cache failed (vs undefined which is \"not yet tried\")\r\n                    return callback(err);\r\n                } else {\r\n                    this._runICACLS(this._getACLArguments(directory, identity), (err) => {\r\n                        Sender.ACLED_DIRECTORIES[directory] = !err;\r\n                        return callback(err);\r\n                    });\r\n                }\r\n            });\r\n        } else {\r\n            return callback(Sender.ACLED_DIRECTORIES[directory] ? null :\r\n                new Error(\"Setting ACL restrictions did not succeed (cached result)\"));\r\n        }\r\n    }\r\n\r\n    private _applyACLRulesSync(directory: string) {\r\n        if (Sender.USE_ICACLS) {\r\n            // For performance, only run ACL rules if we haven't already during this session\r\n            if (Sender.ACLED_DIRECTORIES[directory] === undefined) {\r\n                this._runICACLSSync(this._getACLArguments(directory, this._getACLIdentitySync()));\r\n                Sender.ACLED_DIRECTORIES[directory] = true; // If we get here, it succeeded. _runIACLSSync will throw on failures\r\n                return;\r\n            } else if (!Sender.ACLED_DIRECTORIES[directory]) { // falsy but not undefined\r\n                throw new Error(\"Setting ACL restrictions did not succeed (cached result)\");\r\n            }\r\n        }\r\n    }\r\n\r\n    private _confirmDirExists(directory: string, callback: (err: NodeJS.ErrnoException) => void): void {\r\n        fs.lstat(directory, (err, stats) => {\r\n            if (err && err.code === 'ENOENT') {\r\n                fs.mkdir(directory, (err) => {\r\n                    if (err && err.code !== 'EEXIST') { // Handle race condition by ignoring EEXIST\r\n                        callback(err);\r\n                    } else {\r\n                        this._applyACLRules(directory, callback);\r\n                    }\r\n                });\r\n            } else if (!err && stats.isDirectory()) {\r\n                this._applyACLRules(directory, callback);\r\n            } else {\r\n                callback(err || new Error(\"Path existed but was not a directory\"));\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Computes the size (in bytes) of all files in a directory at the root level. Asynchronously.\r\n     */\r\n    private _getShallowDirectorySize(directory: string, callback: (err: NodeJS.ErrnoException, size: number) => void) {\r\n        // Get the directory listing\r\n        fs.readdir(directory, (err, files) => {\r\n            if (err) {\r\n                return callback(err, -1);\r\n            }\r\n\r\n            let error: NodeJS.ErrnoException = null;\r\n            let totalSize = 0;\r\n            let count = 0;\r\n\r\n            if (files.length === 0) {\r\n                callback(null, 0);\r\n                return;\r\n            }\r\n\r\n            // Query all file sizes\r\n            for (let i = 0; i < files.length; i++) {\r\n                fs.stat(path.join(directory, files[i]), (err, fileStats) => {\r\n                    count++;\r\n\r\n                    if (err) {\r\n                        error = err;\r\n                    } else {\r\n                        if (fileStats.isFile()) {\r\n                            totalSize += fileStats.size;\r\n                        }\r\n                    }\r\n\r\n                    if (count === files.length) {\r\n                        // Did we get an error?\r\n                        if (error) {\r\n                            callback(error, -1);\r\n                        } else {\r\n                            callback(error, totalSize);\r\n                        }\r\n                    }\r\n                });\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Computes the size (in bytes) of all files in a directory at the root level. Synchronously.\r\n     */\r\n    private _getShallowDirectorySizeSync(directory: string): number {\r\n        let files = fs.readdirSync(directory);\r\n        let totalSize = 0;\r\n        for (let i = 0; i < files.length; i++) {\r\n            totalSize += fs.statSync(path.join(directory, files[i])).size;\r\n        }\r\n        return totalSize;\r\n    }\r\n\r\n    /**\r\n     * Stores the payload as a json file on disk in the temp directory\r\n     */\r\n    private _storeToDisk(envelopes: Contracts.EnvelopeTelemetry[]) {\r\n        // This will create the dir if it does not exist\r\n        // Default permissions on *nix are directory listing from other users but no file creations\r\n        Logging.info(Sender.TAG, \"Checking existence of data storage directory: \" + this._tempDir);\r\n        this._confirmDirExists(this._tempDir, (error) => {\r\n            if (error) {\r\n                Logging.warn(Sender.TAG, \"Error while checking/creating directory: \" + (error && error.message));\r\n                this._onErrorHelper(error);\r\n                return;\r\n            }\r\n\r\n            this._getShallowDirectorySize(this._tempDir, (err, size) => {\r\n                if (err || size < 0) {\r\n                    Logging.warn(Sender.TAG, \"Error while checking directory size: \" + (err && err.message));\r\n                    this._onErrorHelper(err);\r\n                    return;\r\n                } else if (size > this._maxBytesOnDisk) {\r\n                    Logging.warn(Sender.TAG, \"Not saving data due to max size limit being met. Directory size in bytes is: \" + size);\r\n                    return;\r\n                }\r\n\r\n                //create file - file name for now is the timestamp, a better approach would be a UUID but that\r\n                //would require an external dependency\r\n                var fileName = new Date().getTime() + \".ai.json\";\r\n                var fileFullPath = path.join(this._tempDir, fileName);\r\n\r\n                // Mode 600 is w/r for creator and no read access for others (only applies on *nix)\r\n                // For Windows, ACL rules are applied to the entire directory (see logic in _confirmDirExists and _applyACLRules)\r\n                Logging.info(Sender.TAG, \"saving data to disk at: \" + fileFullPath);\r\n                fs.writeFile(fileFullPath, this._stringify(envelopes), { mode: 0o600 }, (error) => this._onErrorHelper(error));\r\n            });\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Stores the payload as a json file on disk using sync file operations\r\n     * this is used when storing data before crashes\r\n     */\r\n    private _storeToDiskSync(payload: any) {\r\n        try {\r\n            Logging.info(Sender.TAG, \"Checking existence of data storage directory: \" + this._tempDir);\r\n            if (!fs.existsSync(this._tempDir)) {\r\n                fs.mkdirSync(this._tempDir);\r\n            }\r\n\r\n            // Make sure permissions are valid\r\n            this._applyACLRulesSync(this._tempDir);\r\n\r\n            let dirSize = this._getShallowDirectorySizeSync(this._tempDir);\r\n            if (dirSize > this._maxBytesOnDisk) {\r\n                Logging.info(Sender.TAG, \"Not saving data due to max size limit being met. Directory size in bytes is: \" + dirSize);\r\n                return;\r\n            }\r\n\r\n            //create file - file name for now is the timestamp, a better approach would be a UUID but that\r\n            //would require an external dependency\r\n            var fileName = new Date().getTime() + \".ai.json\";\r\n            var fileFullPath = path.join(this._tempDir, fileName);\r\n\r\n            // Mode 600 is w/r for creator and no access for anyone else (only applies on *nix)\r\n            Logging.info(Sender.TAG, \"saving data before crash to disk at: \" + fileFullPath);\r\n            fs.writeFileSync(fileFullPath, payload, { mode: 0o600 });\r\n\r\n        } catch (error) {\r\n            Logging.warn(Sender.TAG, \"Error while saving data to disk: \" + (error && error.message));\r\n            this._onErrorHelper(error);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Check for temp telemetry files\r\n     * reads the first file if exist, deletes it and tries to send its load\r\n     */\r\n    private _sendFirstFileOnDisk(): void {\r\n\r\n        fs.exists(this._tempDir, (exists: boolean) => {\r\n            if (exists) {\r\n                fs.readdir(this._tempDir, (error, files) => {\r\n                    if (!error) {\r\n                        files = files.filter(f => path.basename(f).indexOf(\".ai.json\") > -1);\r\n                        if (files.length > 0) {\r\n                            var firstFile = files[0];\r\n                            var filePath = path.join(this._tempDir, firstFile);\r\n                            fs.readFile(filePath, (error, buffer) => {\r\n                                if (!error) {\r\n                                    // delete the file first to prevent double sending\r\n                                    fs.unlink(filePath, (error) => {\r\n                                        if (!error) {\r\n                                            try {\r\n                                                let envelopes: Contracts.EnvelopeTelemetry[] = JSON.parse(buffer.toString());\r\n                                                this.send(envelopes);\r\n                                            }\r\n                                            catch (error) {\r\n                                                Logging.warn(\"Failed to read persisted file\", error);\r\n                                            }\r\n                                        } else {\r\n                                            this._onErrorHelper(error);\r\n                                        }\r\n                                    });\r\n                                } else {\r\n                                    this._onErrorHelper(error);\r\n                                }\r\n                            });\r\n                        }\r\n                    } else {\r\n                        this._onErrorHelper(error);\r\n                    }\r\n                });\r\n            }\r\n        });\r\n    }\r\n\r\n    private _onErrorHelper(error: Error): void {\r\n        if (typeof this._onError === \"function\") {\r\n            this._onError(error);\r\n        }\r\n    }\r\n\r\n    private _stringify(payload: any) {\r\n        try {\r\n            return JSON.stringify(payload);\r\n        } catch (error) {\r\n            Logging.warn(\"Failed to serialize payload\", error, payload);\r\n        }\r\n    }\r\n\r\n    private _fileCleanupTask() {\r\n        fs.exists(this._tempDir, (exists: boolean) => {\r\n            if (exists) {\r\n                fs.readdir(this._tempDir, (error, files) => {\r\n                    if (!error) {\r\n                        files = files.filter(f => path.basename(f).indexOf(\".ai.json\") > -1);\r\n                        if (files.length > 0) {\r\n\r\n                            files.forEach(file => {\r\n                                // Check expiration\r\n                                let fileCreationDate: Date = new Date(parseInt(file.split(\".ai.json\")[0]));\r\n                                let expired = new Date(+(new Date()) - Sender.FILE_RETEMPTION_PERIOD) > fileCreationDate;\r\n                                if (expired) {\r\n                                    var filePath = path.join(this._tempDir, file);\r\n                                    fs.unlink(filePath, (error) => {\r\n                                        if (error) {\r\n                                            this._onErrorHelper(error);\r\n                                        }\r\n                                    });\r\n                                }\r\n                            });\r\n                        }\r\n                    } else {\r\n                        this._onErrorHelper(error);\r\n                    }\r\n                });\r\n            }\r\n        });\r\n    }\r\n}\r\n\r\nexport = Sender;\r\n"]}